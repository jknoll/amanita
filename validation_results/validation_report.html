
<!DOCTYPE html>
<html>
<head>
    <title>Validation Report - Multi-Task BEiT Fungi Classification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        .metric-good { color: #27ae60; font-weight: bold; }
        .metric-medium { color: #f39c12; font-weight: bold; }
        .metric-poor { color: #e74c3c; font-weight: bold; }
        .key-finding { background-color: #e8f6f3; border-left: 4px solid #1abc9c; padding: 15px; margin: 20px 0; }
        .warning { background-color: #fdf2e9; border-left: 4px solid #e67e22; padding: 15px; margin: 20px 0; }
        .image-container { text-align: center; margin: 20px 0; }
        img { max-width: 100%; height: auto; border: 1px solid #ddd; }
        .summary-box { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 20px 0; }

        /* Wrapper to constrain width of visualizations */
        .viz-container {
            max-width: 900px;
            margin: 20px auto;
        }

        /* 2x3 Grid for confusion matrices */
        .cm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 0;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }
        .cm-cell {
            text-align: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .cm-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .cm-cell h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        .cm-cell img {
            width: 100%;
            height: auto;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .cm-cell .classes {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Lightbox modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            cursor: pointer;
        }
        .modal-content {
            display: block;
            max-width: 95%;
            max-height: 95%;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #fff;
            border-radius: 5px;
        }
        .modal-title {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover { color: #ccc; }
    </style>
</head>
<body>
    <h1>Validation Report: Multi-Task BEiT for Hierarchical Fungi Classification</h1>

    <div class="summary-box">
        <h2>Summary</h2>
        <p><strong>Model:</strong> BEiT Multi-Task (6 classification heads)</p>
        <p><strong>Validation Samples:</strong> 89,659</p>
        <p><strong>Hierarchical Accuracy:</strong> <span class="metric-medium">30.29%</span></p>
    </div>

    <h2>Per-Rank Metrics</h2>
    <table>
        <tr>
            <th>Rank</th>
            <th>Top-1 Accuracy</th>
            <th>Top-5 Accuracy</th>
            <th>Precision</th>
            <th>Recall</th>
            <th>F1 (Macro)</th>
            <th>Avg Confidence</th>
        </tr>

        <tr>
            <td><strong>Phylum</strong></td>
            <td class="metric-good">89.91%</td>
            <td>99.97%</td>
            <td>66.82%</td>
            <td>65.73%</td>
            <td>62.66%</td>
            <td>0.956</td>
        </tr>

        <tr>
            <td><strong>Class</strong></td>
            <td class="metric-good">85.87%</td>
            <td>97.73%</td>
            <td>52.89%</td>
            <td>55.57%</td>
            <td>51.25%</td>
            <td>0.934</td>
        </tr>

        <tr>
            <td><strong>Order</strong></td>
            <td class="metric-medium">70.57%</td>
            <td>91.99%</td>
            <td>44.31%</td>
            <td>44.88%</td>
            <td>40.44%</td>
            <td>0.833</td>
        </tr>

        <tr>
            <td><strong>Family</strong></td>
            <td class="metric-medium">55.74%</td>
            <td>81.40%</td>
            <td>41.47%</td>
            <td>39.77%</td>
            <td>36.88%</td>
            <td>0.709</td>
        </tr>

        <tr>
            <td><strong>Genus</strong></td>
            <td class="metric-medium">52.02%</td>
            <td>76.08%</td>
            <td>35.41%</td>
            <td>33.16%</td>
            <td>30.52%</td>
            <td>0.656</td>
        </tr>

        <tr>
            <td><strong>Species</strong></td>
            <td class="metric-poor">45.43%</td>
            <td>69.12%</td>
            <td>28.95%</td>
            <td>24.90%</td>
            <td>23.38%</td>
            <td>0.548</td>
        </tr>
    </table>

    <h2>Confidence Distributions</h2>
    <div class="viz-container">
        <img src="confidence_distributions.png" alt="Confidence Distributions" style="width: 100%; border: 1px solid #ddd;">
    </div>

    <h2>Confusion Matrices (Row-Normalized, Viridis)</h2>
    <p>These matrices show what proportion of each true class gets predicted as each other class.
    Row-normalization is essential due to extreme class imbalance (79% Basidiomycota at phylum level, 75% Agaricomycetes at class level).</p>
    <p style="color: #7f8c8d; font-size: 13px;"><em>Click any image to view full size.</em></p>

    <div class="viz-container">
    <div class="cm-grid">
        <div class="cm-cell">
            <h4>Phylum</h4>
            <img src="confusion_matrix_phylum_normalized_viridis.png" alt="Confusion Matrix - Phylum"
                 onclick="openModal(this.src, 'Phylum (7 classes) - Acc: 89.91%')">
            <div class="classes">7 classes</div>
        </div>
        <div class="cm-cell">
            <h4>Class</h4>
            <img src="confusion_matrix_class_normalized_viridis.png" alt="Confusion Matrix - Class"
                 onclick="openModal(this.src, 'Class (28 classes) - Acc: 85.87%')">
            <div class="classes">28 classes</div>
        </div>
        <div class="cm-cell">
            <h4>Order</h4>
            <img src="confusion_matrix_order_normalized_viridis.png" alt="Confusion Matrix - Order"
                 onclick="openModal(this.src, 'Order (95 classes) - Acc: 70.57%')">
            <div class="classes">95 classes</div>
        </div>
        <div class="cm-cell">
            <h4>Family</h4>
            <img src="confusion_matrix_family_normalized_viridis.png" alt="Confusion Matrix - Family"
                 onclick="openModal(this.src, 'Family (308 classes) - Acc: 55.74%')">
            <div class="classes">308 classes</div>
        </div>
        <div class="cm-cell">
            <h4>Genus</h4>
            <img src="confusion_matrix_genus_normalized_viridis.png" alt="Confusion Matrix - Genus"
                 onclick="openModal(this.src, 'Genus (918 classes) - Acc: 52.02%')">
            <div class="classes">918 classes</div>
        </div>
        <div class="cm-cell">
            <h4>Species</h4>
            <img src="confusion_matrix_species_normalized_viridis.png" alt="Confusion Matrix - Species"
                 onclick="openModal(this.src, 'Species (2786 classes) - Acc: 45.43%')">
            <div class="classes">2786 classes</div>
        </div>
    </div>
    </div>

    <!-- Modal for full-size images -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
        <div class="modal-title" id="modalTitle"></div>
    </div>

    <h2>Amanita phalloides (Death Cap) Analysis</h2>
    <div class="warning">
        <strong>Important:</strong> Amanita phalloides is one of the most poisonous mushrooms. 
        Accurate identification is critical for public safety.
    </div>

    <table>
        <tr>
            <th>Taxonomic Rank</th>
            <th>Expected Value</th>
            <th>Correct</th>
            <th>Total</th>
            <th>Accuracy</th>
        </tr>

        <tr>
            <td><strong>Phylum</strong></td>
            <td>Basidiomycota</td>
            <td>133</td>
            <td>135</td>
            <td class="metric-good">98.52%</td>
        </tr>

        <tr>
            <td><strong>Class</strong></td>
            <td>Agaricomycetes</td>
            <td>133</td>
            <td>135</td>
            <td class="metric-good">98.52%</td>
        </tr>

        <tr>
            <td><strong>Order</strong></td>
            <td>Agaricales</td>
            <td>83</td>
            <td>135</td>
            <td class="metric-medium">61.48%</td>
        </tr>

        <tr>
            <td><strong>Family</strong></td>
            <td>Amanitaceae</td>
            <td>60</td>
            <td>135</td>
            <td class="metric-poor">44.44%</td>
        </tr>

        <tr>
            <td><strong>Genus</strong></td>
            <td>Amanita</td>
            <td>43</td>
            <td>135</td>
            <td class="metric-poor">31.85%</td>
        </tr>

        <tr>
            <td><strong>Species</strong></td>
            <td>Amanita phalloides</td>
            <td>58</td>
            <td>135</td>
            <td class="metric-poor">42.96%</td>
        </tr>

    </table>

    <div class="key-finding">
        <h3>Key Finding</h3>
        <p><strong>Species-level recognition:</strong> 42.96%</p>
        <p><strong>Genus-level recognition (Amanita):</strong> 31.85%</p>
        <p>Even when the exact species is misidentified, the model correctly identifies 
           the genus as Amanita in 31.85% of cases, which is valuable for 
           flagging potentially dangerous specimens.</p>
    </div>

    <h2>Specimen Examples</h2>
    <h3>Well-Recognized Specimens</h3>
    <div class="image-container">
        <img src="well_recognized_specimens.png" alt="Well-Recognized Specimens">
    </div>

    <h3>Poorly-Recognized Specimens</h3>
    <div class="image-container">
        <img src="poorly_recognized_specimens.png" alt="Poorly-Recognized Specimens">
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d;">
        <p>Generated by validation_notebook.ipynb</p>
    </footer>

    <script>
        function openModal(src, title) {
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('modalImage').src = src;
            document.getElementById('modalTitle').textContent = title;
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
